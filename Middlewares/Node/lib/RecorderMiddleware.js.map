{"version":3,"sources":["../src/RecorderMiddleware.js"],"names":["ORIENTATION_INCOMING","ORIENTATION_OUTGOING","RecordUser","event","serviceUrl","address","bot_client_id","bot","id","bot_client_name","name","user_client_id","user","user_client_name","channel_id","channelId","extra","undefined","JSON","stringify","saveUser","RecordMessage","orientation","msg_id","v1","msg_type","type","text","source","agent","conversation_id","conversation","time","Date","getTime","saveMessage","RecorderMiddleware","next"],"mappings":"AAAA;;;;;;;;AAEA;;AACA;;;;AAEA;;;;;;;;AAEA,IAAMA,uBAAuB,CAA7B;AACA,IAAMC,uBAAuB,CAA7B;;AAGA,SAASC,UAAT,CAAoBC,KAApB,EAA0B;AACtB,QAAIC,aAAaD,MAAME,OAAN,CAAcD,UAA/B;AACA,QAAIE,gBAAgBH,MAAME,OAAN,CAAcE,GAAd,CAAkBC,EAAtC;AACA,QAAIC,kBAAkBN,MAAME,OAAN,CAAcE,GAAd,CAAkBG,IAAxC;AACA,QAAIC,iBAAiBR,MAAME,OAAN,CAAcO,IAAd,CAAmBJ,EAAxC;AACA,QAAIK,mBAAmBV,MAAME,OAAN,CAAcO,IAAd,CAAmBF,IAA1C;AACA,QAAII,aAAaX,MAAME,OAAN,CAAcU,SAA/B;AACA,QAAIC,QAAQ,IAAZ;AACA,QAAGb,MAAME,OAAN,IAAiBY,SAApB,EAA8B;AAC1BD,gBAAQE,KAAKC,SAAL,CAAehB,MAAME,OAArB,CAAR;AACH;AACD,uBAASe,QAAT,CACIhB,aAAWA,UADf,EAEIE,gBAAcA,aAFlB,EAGIG,kBAAgBA,eAHpB,EAIIE,iBAAeA,cAJnB,EAKIE,mBAAiBA,gBALrB,EAMIC,aAAWA,UANf,EAOIE,QAAMA,KAPV;AASH;;AAED,SAASK,aAAT,CAAuBlB,KAAvB,EAA8BmB,WAA9B,EAA0C;AACtC,QAAIC,SAAS,mBAAKC,EAAL,EAAb;AACA,QAAIC,WAAWtB,MAAMuB,IAArB;AACA,QAAIC,OAAOxB,MAAMwB,IAAjB;AACA,QAAIC,SAASzB,MAAMyB,MAAnB;AACA,QAAIC,QAAQ1B,MAAM0B,KAAlB;AACA,QAAIzB,aAAaD,MAAME,OAAN,CAAcD,UAA/B;AACA,QAAIO,iBAAiBR,MAAME,OAAN,CAAcO,IAAd,CAAmBJ,EAAxC;AACA,QAAIK,mBAAmBV,MAAME,OAAN,CAAcO,IAAd,CAAmBF,IAA1C;AACA,QAAIJ,gBAAgBH,MAAME,OAAN,CAAcE,GAAd,CAAkBC,EAAtC;AACA,QAAIC,kBAAkBN,MAAME,OAAN,CAAcE,GAAd,CAAkBG,IAAxC;AACA,QAAII,aAAaX,MAAME,OAAN,CAAcU,SAA/B;AACA,QAAIe,kBAAkB3B,MAAME,OAAN,CAAc0B,YAAd,CAA2BvB,EAAjD;AACA,QAAIwB,OAAO,IAAIC,IAAJ,GAAWC,OAAX,EAAX;AACA,uBAASC,WAAT,CACIZ,SAAOA,MADX,EAEIE,WAASA,QAFb,EAGIE,OAAKA,IAHT,EAIIC,SAAOA,MAJX,EAKIC,QAAMA,KALV,EAMIzB,aAAWA,UANf,EAOIO,iBAAeA,cAPnB,EAQIE,mBAAiBA,gBARrB,EASIP,gBAAcA,aATlB,EAUIG,kBAAgBA,eAVpB,EAWIK,aAAWA,UAXf,EAYIgB,kBAAgBA,eAZpB,EAaIR,cAAYA,WAbhB,EAcIU,OAAKA,IAdT;AAgBH;;IAEoBI,kB;;;;;;;gCACTjC,K,EAAOkC,I,EAAK;AAChBnC,uBAAWC,KAAX;AACAkB,0BAAclB,KAAd,EAAqBH,oBAArB;AACAqC;AACH;;;6BAEIlC,K,EAAOkC,I,EAAK;AACbhB,0BAAclB,KAAd,EAAqBF,oBAArB;AACAoC;AACH;;;;;;kBAVgBD,kB","file":"RecorderMiddleware.js","sourcesContent":["\"use strict\";\r\n\r\nimport \"babel-polyfill\";\r\nimport uuid from 'node-uuid';\r\n\r\nimport schedule from './Schedule';\r\n\r\nconst ORIENTATION_INCOMING = 1;\r\nconst ORIENTATION_OUTGOING = 2;\r\n\r\n\r\nfunction RecordUser(event){\r\n    let serviceUrl = event.address.serviceUrl;\r\n    let bot_client_id = event.address.bot.id;\r\n    let bot_client_name = event.address.bot.name;\r\n    let user_client_id = event.address.user.id;\r\n    let user_client_name = event.address.user.name;\r\n    let channel_id = event.address.channelId;\r\n    let extra = null;\r\n    if(event.address != undefined){\r\n        extra = JSON.stringify(event.address);\r\n    }\r\n    schedule.saveUser(\r\n        serviceUrl=serviceUrl,\r\n        bot_client_id=bot_client_id,\r\n        bot_client_name=bot_client_name,\r\n        user_client_id=user_client_id,\r\n        user_client_name=user_client_name,\r\n        channel_id=channel_id,\r\n        extra=extra\r\n    );\r\n}\r\n\r\nfunction RecordMessage(event, orientation){\r\n    let msg_id = uuid.v1();\r\n    let msg_type = event.type;\r\n    let text = event.text;\r\n    let source = event.source;\r\n    let agent = event.agent;\r\n    let serviceUrl = event.address.serviceUrl;\r\n    let user_client_id = event.address.user.id;\r\n    let user_client_name = event.address.user.name;\r\n    let bot_client_id = event.address.bot.id;\r\n    let bot_client_name = event.address.bot.name;\r\n    let channel_id = event.address.channelId;\r\n    let conversation_id = event.address.conversation.id;\r\n    let time = new Date().getTime();\r\n    schedule.saveMessage(\r\n        msg_id=msg_id,\r\n        msg_type=msg_type,\r\n        text=text,\r\n        source=source,\r\n        agent=agent,\r\n        serviceUrl=serviceUrl,\r\n        user_client_id=user_client_id,\r\n        user_client_name=user_client_name,\r\n        bot_client_id=bot_client_id,\r\n        bot_client_name=bot_client_name,\r\n        channel_id=channel_id,\r\n        conversation_id=conversation_id,\r\n        orientation=orientation,\r\n        time=time\r\n    );\r\n}\r\n\r\nexport default class RecorderMiddleware {\r\n    receive(event, next){\r\n        RecordUser(event);\r\n        RecordMessage(event, ORIENTATION_INCOMING);\r\n        next();\r\n    }\r\n\r\n    send(event, next){\r\n        RecordMessage(event, ORIENTATION_OUTGOING);\r\n        next();\r\n    }\r\n\r\n}"]}