{"version":3,"sources":["../src/Schedule.js"],"names":["Schedule","interval","process","env","RECORDER_SYNC_INTERVAL","rule","syncJob","scheduleJob","sync","bind","model","resourcePath","identities","findAll","where","__sync__","__tries__","$lt","then","instances","httpProxy","each","instance","callback","increment","post","err","console","log","hasCache","flush","data","resp","update","syncModel","channel_id","user_id","name","extra","findOrCreate","defaults","spread","created","get","plain","msg_id","text","msg_type","source","agent","user_name","conversation_id","bot_client_id","bot_client_name","orientation","time","create","instance_"],"mappings":"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","file":"Schedule.js","sourcesContent":["\"use strict\";\r\n\r\nimport async from 'async';\r\nimport Schedule_ from 'node-schedule';\r\nimport {UserModel, MessageModel} from './models';\r\nimport {CommonSerializer, IdentitySerializer} from './Serializer';\r\nimport HttpProxy from './HttpProxy';\r\n\r\nclass Schedule {\r\n    constructor(){\r\n        let interval = process.env.RECORDER_SYNC_INTERVAL || 5;\r\n        this.rule = `*/${interval} * * * *`;\r\n        this.syncJob = Schedule_.scheduleJob(this.rule, this.sync.bind(this));\r\n    }\r\n\r\n    syncModel(model, resourcePath, identities){\r\n        model.findAll({where: {__sync__: false, __tries__: {$lt: 3}}}).then(function(instances){\r\n            var httpProxy = new HttpProxy();\r\n            async.each(instances, function(instance, callback){\r\n                instance.increment('__tries__').then(function(){\r\n                    httpProxy.post(resourcePath, CommonSerializer(instance));\r\n                    callback();\r\n                }.bind(this));\r\n            }, function(err){\r\n                if(err){\r\n                    console.log(err);\r\n                } else if(httpProxy.hasCache()){\r\n                    httpProxy.flush(function(err, data, resp){\r\n                        if(err){\r\n                            console.log(err);\r\n                        } else {\r\n                            model.update({__sync__: true}, { \r\n                                where: IdentitySerializer(data, identities)\r\n                            });\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    sync(){\r\n        this.syncModel(UserModel, '/api/v1/users', ['channel_id', 'user_id']);\r\n        this.syncModel(MessageModel, '/api/v1/messages', ['msg_id']);\r\n    }\r\n\r\n    saveUser(channel_id, user_id, name, extra){\r\n        return UserModel.findOrCreate({\r\n            where: {\r\n                channel_id: channel_id,\r\n                user_id: user_id\r\n            }, \r\n            defaults: {\r\n                name: name,\r\n                extra: extra\r\n            }\r\n        }).spread(function(instance, created){\r\n            console.log(instance.get({plain: true}));\r\n            return created;\r\n        });\r\n    }\r\n\r\n    saveMessage(\r\n        msg_id, text, msg_type, source, agent, user_id,\r\n        user_name, channel_id, conversation_id,\r\n        bot_client_id, bot_client_name, orientation, time){\r\n        return MessageModel.create({\r\n            msg_id: msg_id,\r\n            text: text,\r\n            msg_type: msg_type,\r\n            source: source,\r\n            agent: agent,\r\n            user_id: user_id,\r\n            user_name: user_name,\r\n            channel_id: channel_id,\r\n            conversation_id: conversation_id,\r\n            bot_client_id: bot_client_id,\r\n            bot_client_name: bot_client_name,\r\n            orientation: orientation,\r\n            time: time\r\n        }).then(function(instance){\r\n            let instance_ = instance.get({plain: true});\r\n            console.log(instance_.text);\r\n            return instance_;\r\n        });\r\n    }\r\n}\r\n\r\nexport default new Schedule();"]}